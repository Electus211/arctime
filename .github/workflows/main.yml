name: Arctime Auto Sign

on:
  schedule:
    - cron: '30 0 * * *'
  workflow_dispatch:

jobs:
  sign:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: |
          pip install requests pyopenssl

      - name: Run sign script
        id: sign
        env:
          USERNAME: ${{ secrets.USERNAME }}
          PASSWORD: ${{ secrets.PASSWORD }}
          MATL_USERNAME: ${{ secrets.MATL_USERNAME }}
          MATL_PASSWORD: ${{ secrets.MATL_PASSWORD }}
          MATL_SMTP_SERVER: ${{ secrets.MATL_SMTP_SERVER }}
          MATL_TO: ${{ secrets.MATL_TO }}
        run: |
          mkdir -p logs
          LOG_FILE="logs/arctime_$(date +%Y%m%d_%H%M%S).log"
          
          cat << 'EOF' > sign.py
          import os
          import re
          import json
          import requests
          import smtplib
          import logging
          from email.mime.text import MIMEText

          logging.basicConfig(
              level=logging.INFO,
              format='%(asctime)s [%(levelname)s] %(message)s',
              handlers=[logging.StreamHandler()]
          )
          logger = logging.getLogger(__name__)

          def send_email_with_retry(subject, content, max_retries=3):
              for i in range(max_retries):
                  try:
                      msg = MIMEText(content, 'plain', 'utf-8')
                      msg['Subject'] = f"[Arctime] {subject}"
                      msg['From'] = os.getenv('MATL_USERNAME')
                      msg['To'] = os.getenv('MATL_TO')
                      
                      with smtplib.SMTP(os.getenv('MATL_SMTP_SERVER'), 587, timeout=15) as s:
                          s.ehlo()
                          s.starttls()
                          s.ehlo()
                          s.login(os.getenv('MATL_USERNAME'), os.getenv('MATL_PASSWORD'))
                          s.send_message(msg)
                      logger.info("âœ… é‚®ä»¶å‘é€æˆåŠŸ")
                      return True
                  except Exception as e:
                      logger.warning(f"âš ï¸ é‚®ä»¶å‘é€å¤±è´¥(å°è¯• {i+1}/{max_retries}): {str(e)}")
              return False

          def get_valid_api():
              # å°è¯•å¤šä¸ªå¯èƒ½çš„APIç«¯ç‚¹
              apis = [
                  "https://m.arctime.cn/api/sign/new",  # æ–°æŽ¥å£
                  "https://api.arctime.cn/v2/sign",     # å¤‡ç”¨æŽ¥å£
                  "https://m.arctime.cn/sign/submit"    # æ—§æŽ¥å£
              ]
              for api in apis:
                  try:
                      test_res = requests.head(api, timeout=5)
                      if test_res.status_code != 404:
                          return api
                  except:
                      continue
              return None

          try:
              logger.info("==== ä»»åŠ¡å¼€å§‹ ====")
              
              # 1. ç™»å½•
              session = requests.Session()
              login_res = session.post(
                  "https://m.arctime.cn/home/user/login_save.html",
                  data={
                      'username': os.getenv('USERNAME'),
                      'password': os.getenv('PASSWORD'),
                      'login_type': '2'
                  },
                  verify=False,
                  timeout=15
              )
              
              if login_res.status_code != 200:
                  raise Exception(f"ç™»å½•è¯·æ±‚å¤±è´¥: HTTP {login_res.status_code}")
                  
              login_data = json.loads(re.search(r'\{.*\}', login_res.text).group())
              if login_data.get('status') != 1:
                  raise Exception(f"ç™»å½•å¤±è´¥: {login_data.get('msg')}")
              
              logger.info("âœ… ç™»å½•æˆåŠŸ")
              
              # 2. æŸ¥æ‰¾æœ‰æ•ˆAPI
              sign_api = get_valid_api()
              if not sign_api:
                  raise Exception("âŒ æ‰¾ä¸åˆ°æœ‰æ•ˆçš„ç­¾åˆ°æŽ¥å£")
                  
              logger.info(f"ðŸ” ä½¿ç”¨æŽ¥å£: {sign_api}")
              
              # 3. æ‰§è¡Œç­¾åˆ°
              sign_res = session.post(sign_api, verify=False, timeout=15)
              if sign_res.status_code == 404:
                  raise Exception("ç­¾åˆ°æŽ¥å£404é”™è¯¯ï¼Œè¯·æ‰‹åŠ¨ç¡®è®¤é¡µé¢å˜æ›´")
                  
              sign_data = json.loads(re.search(r'\{.*\}', sign_res.text).group())
              if sign_data.get('status') == 1:
                  logger.info(f"ðŸŽ‰ ç­¾åˆ°æˆåŠŸ: {sign_data.get('msg')}")
                  send_email_with_retry("ç­¾åˆ°æˆåŠŸ", f"ç»“æžœ: {sign_data.get('msg')}")
              else:
                  raise Exception(f"ç­¾åˆ°å¤±è´¥: {sign_data.get('msg')}")
                  
          except Exception as e:
              logger.error(f"ðŸš¨ ç³»ç»Ÿå¼‚å¸¸: {str(e)}")
              send_email_with_retry("æ‰§è¡Œå¤±è´¥", str(e))
              exit(1)
          finally:
              logger.info("==== ä»»åŠ¡ç»“æŸ ====")
          EOF

          python sign.py 2>&1 | tee $LOG_FILE
          echo "log_file=$LOG_FILE" >> $GITHUB_OUTPUT

      - name: Upload logs
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: arctime-logs
          path: ${{ steps.sign.outputs.log_file }}
