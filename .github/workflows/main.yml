name: Arctime Auto Sign

on:
  schedule:
    - cron: '30 0 * * *'  # UTCæ—¶é—´0:30ï¼ˆåŒ—äº¬æ—¶é—´8:30ï¼‰
  workflow_dispatch:

jobs:
  sign:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          pip install requests

      - name: Run sign script
        env:
          USERNAME: ${{ secrets.USERNAME }}
          PASSWORD: ${{ secrets.PASSWORD }}
          MATL_USERNAME: ${{ secrets.MATL_USERNAME }}
          MATL_PASSWORD: ${{ secrets.MATL_PASSWORD }}
          MATL_SMTP_SERVER: ${{ secrets.MATL_SMTP_SERVER }}
          MATL_TO: ${{ secrets.MATL_TO }}
        run: |
          # ç”Ÿæˆå¸¦æ—¶é—´æˆ³çš„æ—¥å¿—æ–‡ä»¶
          LOG_FILE="arctime_sign_$(date +%Y%m%d%H%M%S).log"
          
          # æ‰§è¡Œè„šæœ¬å¹¶è®°å½•æ—¥å¿—
          python << 'EOF' | tee $LOG_FILE
          import os
          import requests
          import smtplib
          import logging
          from email.mime.text import MIMEText

          # æ—¥å¿—é…ç½®
          logging.basicConfig(
              level=logging.INFO,
              format='%(asctime)s [%(levelname)s] %(message)s',
              handlers=[logging.StreamHandler()]
          )
          logger = logging.getLogger(__name__)

          def send_email(subject, content):
              try:
                  msg = MIMEText(content, 'plain', 'utf-8')
                  msg['Subject'] = f"[Arctime] {subject}"
                  msg['From'] = os.getenv('MATL_USERNAME')
                  msg['To'] = os.getenv('MATL_TO')
                  
                  with smtplib.SMTP(os.getenv('MATL_SMTP_SERVER'), 587, timeout=10) as server:
                      server.starttls()
                      server.login(os.getenv('MATL_USERNAME'), os.getenv('MATL_PASSWORD'))
                      server.send_message(msg)
                  logger.info("é‚®ä»¶å‘é€æˆåŠŸ")
                  return True
              except Exception as e:
                  logger.error(f"é‚®ä»¶å‘é€å¤±è´¥: {str(e)}")
                  return False

          # ä¸»é€»è¾‘
          try:
              logger.info("==== ä»»åŠ¡å¼€å§‹ ====")
              
              # ç™»å½•Arctime
              session = requests.Session()
              login_res = session.post(
                  "https://m.arctime.cn/home/user/login_save.html",
                  data={
                      "username": os.getenv('USERNAME'),
                      "password": os.getenv('PASSWORD'),
                      "login_type": "2"
                  },
                  verify=False,
                  timeout=10
              )
              
              if login_res.json().get("status") == 1:
                  logger.info("âœ… ç™»å½•æˆåŠŸ")
                  
                  # æ£€æŸ¥ç­¾åˆ°çŠ¶æ€
                  ucenter_res = session.get("https://m.arctime.cn/home/ucenter", verify=False)
                  if "ä»Šæ—¥å·²ç­¾åˆ°" in ucenter_res.text:
                      logger.info("â­ï¸ ä»Šæ—¥å·²ç­¾åˆ°")
                      send_email("ç­¾åˆ°çŠ¶æ€", "ä»Šæ—¥å·²ç­¾åˆ°ï¼Œæ— éœ€é‡å¤æ“ä½œ")
                  else:
                      sign_res = session.post("https://m.arctime.cn/api/user/sign", verify=False)
                      if sign_res.json().get("status") == 1:
                          logger.info("ğŸ‰ ç­¾åˆ°æˆåŠŸ")
                          send_email("ç­¾åˆ°æˆåŠŸ", "ä»Šæ—¥ç­¾åˆ°å·²å®Œæˆ")
                      else:
                          logger.error("âŒ ç­¾åˆ°å¤±è´¥: %s", sign_res.text[:200])
                          send_email("ç­¾åˆ°å¤±è´¥", f"æœåŠ¡å™¨è¿”å›: {sign_res.text[:200]}")
              else:
                  error_msg = login_res.json().get("msg", "æœªçŸ¥é”™è¯¯")
                  logger.error(f"âŒ ç™»å½•å¤±è´¥: {error_msg}")
                  send_email("ç™»å½•å¤±è´¥", f"é”™è¯¯ä¿¡æ¯: {error_msg}")

          except Exception as e:
              logger.error(f"ğŸš¨ ç³»ç»Ÿå¼‚å¸¸: {str(e)}")
              send_email("ç³»ç»Ÿå¼‚å¸¸", f"æ‰§è¡Œå‡ºé”™: {str(e)}")
          finally:
              logger.info("==== ä»»åŠ¡ç»“æŸ ====")
          EOF

          # ä¸Šä¼ æ—¥å¿—ï¼ˆä½¿ç”¨æœ€æ–°ç‰ˆartifact actionï¼‰
          if [ -f "$LOG_FILE" ]; then
              echo "LOG_CONTENT=$(cat $LOG_FILE)" >> $GITHUB_OUTPUT
          fi

      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: arctime-logs
          path: ${{ env.LOG_FILE }}
